<?php
/**
 *
 * test.php(屏蔽国家IP)
 *
 */
$verification = '美国';//需要屏蔽国家的IP
function get_client_ip() {
               $ip = $_SERVER['REMOTE_ADDR'];
         if (isset($_SERVER['HTTP_X_REAL_FORWARDED_FOR']) && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER['HTTP_X_REAL_FORWARDED_FOR'])) {
         $ip = $_SERVER['HTTP_X_REAL_FORWARDED_FOR'];
         }
         elseif (isset($_SERVER['HTTP_X_FORWARDED_FOR']) && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER['HTTP_X_FORWARDED_FOR'])) {
         $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
         }
         elseif (isset($_SERVER['HTTP_CLIENT_IP']) && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER['HTTP_CLIENT_IP'])) {
         $ip = $_SERVER['HTTP_CLIENT_IP'];
         }
         return $ip;
         }
$ip = get_client_ip();//获取访客IP
$antecedents = $_SERVER['HTTP_REFERER'];//访客来路地址
$result = file_get_contents("http://ip.taobao.com/service/getIpInfo.php?ip=".$ip);//IP数据库来自淘宝。
$address = json_decode($result,true);
//判断访客是否属于美国，是否来自百度，是否来自谷歌
if($address['data']['country'] == $verification && strpos($antecedents, 'baidu') === false && strpos($antecedents, 'google') === false){
        sleep(10);//设置一个10秒等待。
        header('HTTP/1.1 503 Service Temporarily Unavailable');
        header('Status: 503 Service Temporarily Unavailable');
        header('Retry-After: 3600000');
        exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>教务管理系统</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{% static 'adminLTE/plugins/fontawesome-free/css/all.min.css' %}">
    <!-- icheck bootstrap -->
    <link rel="stylesheet" href="{% static 'adminLTE/plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
    <!-- Theme style -->
    <link rel="stylesheet" href="{% static 'adminLTE/dist/css/adminlte.min.css' %}">
</head>
<body class="hold-transition sidebar-mini layout-fixed sidebar-collapse" style="height: auto;">
<div class="wrapper">

    {#Navbar#}
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        {# Left navbar links #}
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="{% url 'user:index' %}" class="nav-link">Home</a>
            </li>
        </ul>
        {#/.Left navbar links#}

        {#Right navbar links#}
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" data-widget="navbar-search" href="#" role="button">
                    <i class="fas fa-search"></i>
                </a>
                <div class="navbar-search-block">
                    <form class="form-inline">
                        <div class="input-group input-group-sm">
                            <input class="form-control form-control-navbar" type="search" placeholder="Search"
                                   aria-label="Search">
                            <div class="input-group-append">
                                <button class="btn btn-navbar" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </li>
            {#Dropdown Menu#}
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#" aria-expanded="false">
                    <i class="far fa-user"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" style="left: inherit; right: 0;">
                    {% if request.session.is_login %}
                        <span class="dropdown-item dropdown-header">当前在线：{{ request.session.user_name }} {{ request.session.user_kind }}</span>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'user:logout' %}" class="dropdown-item">
                            <i class="fas fa-envelope mr-2"></i> 退出
                            <span class="float-right text-muted text-sm">登录</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-users mr-2"></i> 还没
                            <span class="float-right text-muted text-sm">写完</span>
                        </a>
                    {% else %}
                        <a href="{% url 'user:login' %}" class="dropdown-item">
                            <i class="fas fa-envelope mr-2"></i>
                            <span class="float-right text-muted text-sm">登录</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'user:register' %}" class="dropdown-item">
                            <i class="fas fa-users mr-2"></i>
                            <span class="float-right text-muted text-sm">注册</span>
                        </a>
                    {% endif %}
                </div>
            </li>
            {# /.Dropdown Menu #}
        </ul>
        {#/.Right navbar links#}
    </nav>
    {#/.Navbar#}

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="#" class="brand-link">
            <img src="{% static 'adminLTE/dist/img/AdminLTELogo.png' %}" alt="AdminLTE Logo"
                 class="brand-image img-circle elevation-3"
                 style="opacity: .8">
            <span class="brand-text font-weight-light">AdminLTE 3</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar user panel (optional) -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
                    <img src="{% static 'adminLTE/dist/img/user2-160x160.jpg' %}" class="img-circle elevation-2"
                         alt="User Image">
                </div>
                <div class="info">
                    <a href="#" class="d-block">Alexander Pierce</a>
                </div>
            </div>

            <!-- SidebarSearch Form -->
            <div class="form-inline">
                <div class="input-group" data-widget="sidebar-search">
                    <input class="form-control form-control-sidebar" type="search" placeholder="Search"
                           aria-label="Search">
                    <div class="input-group-append">
                        <button class="btn btn-sidebar">
                            <i class="fas fa-search fa-fw"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                    data-accordion="false">
                    <!-- Add icons to the links using the .nav-icon class
                         with font-awesome or any other icon font library -->
                    {#Dashborad#}
                    <li class="nav-item">
                    <a href="{% url 'user:index_s' %}" class="nav-link">
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        <p>
                            Dashboard
                            <span class="right badge badge-danger">New</span>
                        </p>
                    </a>
                    </li>
                    {#/.Dashboard#}
                    {#teacher#}
                    {% if request.session.user_kind == '教师' %}
                        <li class="nav-item">
                            <a href="{% url 'user:tea1' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    tea1
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'user:tea2' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    tea2
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'user:tea3' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    tea3
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                        {#/.teacher#}
                    {% elif request.session.user_kind == '学生' %}
                        <li class="nav-item">
                            <a href="{% url 'user:stu1' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    stu1
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'user:stu2' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    stu2
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'user:stu3' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    stu3
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'user:stu4' %}" class="nav-link">
                                <i class="nav-icon fas fa-th"></i>
                                <p>
                                    stu4
                                    <span class="right badge badge-danger">New</span>
                                </p>
                            </a>
                        </li>
                    {% elif request.session.user_kind == '管理员' %}
                        <li class="nav-item has-treeview ">
                            <a href="#"
                               class="nav-link ">
                                <i class="nav-icon fas fa-desktop"></i>
                                <p>
                                    Monitor
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="{% url 'cms:userip' %}"
                                       class="nav-link ">
                                        <i class="far fa-address-book nav-icon"></i>
                                        <p>User IP</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="{% url 'cms:banUser' %}"
                                       class="nav-link ">
                                        <i class="far fa-times-circle nav-icon"></i>
                                        <p>Ban User</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/cms/dashboard/monitor/postview"
                                       class="nav-link ">
                                        <i class="fas fa-eye nav-icon"></i>
                                        <p>Post View</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>
    <!-- /.Main Sidebar Container -->

    {# Main Content #}
    <div class="content-wrapper" style="min-height: 815px;">
        {% block content %}{% endblock %}
    </div>

</div>


<footer class="main-footer">
    <div class="float-right d-none d-sm-block">
        <b>Version</b> 3.2.0
    </div>
    <strong>Copyright © 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
</footer>

<!-- jQuery -->
<script src="{% static 'adminLTE/plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'adminLTE/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'adminLTE/dist/js/adminlte.min.js' %}"></script>
<!-- DataTables  & Plugins -->
<script src="{% static 'adminLTE/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/jszip/jszip.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/pdfmake/pdfmake.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/pdfmake/vfs_fonts.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'adminLTE/plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
<!-- ChartJS -->
<script src="{% static 'adminlte/plugins/chart.js/Chart.min.js' %}"></script>
<script>
        $(function () {
        $('#courseSelect').DataTable({
            "paging": true,
            "lengthChange": false,
            "searching": false,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
        });
    });
</script>

<script>
        <!-- 动态刷新验证码js -->
        $(document).ready(function(){
            $('.captcha').click(function () {
                $.getJSON("refresh_captcha/", function (result) {
                    $('#id_captcha').attr('src', result['image_url']);
                    $('#id_captcha_0').val(result['hashkey'])
                });
            });
        });
</script>

<script>
    <!-- chartjs-->
    $(document).ready(function () {
        var ticksStyle = {
            fontColor: '#495057',
            fontStyle: 'bold'
        }
        var $visitorsChart = $('#visitors-chart')
        var visitorsChart2 = new Chart($visitorsChart, {
            data: {
                labels: {{ date_time_list }},
                datasets: [{
                    type: 'line',
                    data: {{ week_data_list }},
                    backgroundColor: 'transparent',
                    borderColor: '#007bff',
                    pointBorderColor: '#007bff',
                    pointBackgroundColor: '#007bff',
                    fill: true
                }]
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                hover: {
                    mode: 'index',
                    intersect: true
                },
                legend: {
                    display: false
                },
                scales: {
                    yAxes: [{
                        // display: false,
                        gridLines: {
                            display: true,
                            lineWidth: '4px',
                            color: 'rgba(0, 0, 0, .2)',
                            zeroLineColor: 'transparent'
                        },
                        ticks: $.extend({
                            beginAtZero: false,
                            suggestedMax: {{ suggested_max }}
                        }, ticksStyle)
                    }],
                    xAxes: [{
                        display: true,
                        gridLines: {
                            display: false
                        },
                        ticks: ticksStyle
                    }]
                }
            }
        })
    })
</script>
</body>

</html>